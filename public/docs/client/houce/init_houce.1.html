<!DOCTYPE html><html><head><title>init_houce.1.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../client/app_init.-1.html" class="source "><span class="base_path">client / </span><span class="file_name">app_init.-1.coffee</span></a><a href="../../client/houce/apis.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">apis.coffee</span></a><a href="../../client/houce/data_and_models.2.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">data_and_models.2.coffee</span></a><a href="../../client/houce/init_houce.1.html" class="source selected"><span class="base_path">client / houce / </span><span class="file_name">init_houce.1.coffee</span></a><a href="../../client/houce/misc.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">misc.coffee</span></a><a href="../../client/houce/pager.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">pager.coffee</span></a><a href="../../client/houce/templates.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">templates.coffee</span></a><a href="../../client/models/person.html" class="source "><span class="base_path">client / models / </span><span class="file_name">person.coffee</span></a><a href="../../client/styles/ccss_helpers.s.html" class="source "><span class="base_path">client / styles / </span><span class="file_name">ccss_helpers.s.coffee</span></a><a href="../../client/utils/dictionary.html" class="source "><span class="base_path">client / utils / </span><span class="file_name">dictionary.coffee</span></a><a href="../../client/utils/utils.html" class="source "><span class="base_path">client / utils / </span><span class="file_name">utils.coffee</span></a><a href="../../common/common_utils.html" class="source "><span class="base_path">common / </span><span class="file_name">common_utils.coffee</span></a><a href="../../server/config.html" class="source "><span class="base_path">server / </span><span class="file_name">config.coffee</span></a><a href="../../server/houce.html" class="source "><span class="base_path">server / </span><span class="file_name">houce.coffee</span></a><a href="../../server/server.html" class="source "><span class="base_path">server / </span><span class="file_name">server.coffee</span></a><a href="../.././start.html" class="source "><span class="base_path">. / </span><span class="file_name">start.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>init_houce.1.coffee</h1><div class="filepath">client/houce/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>If application is directed only for newer browsers that implement
Object.defineProperty you can use Object prototype functions for nicer syntaxt.
http://sugarjs.com/objects#object_extend</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>Object.extend() if Object.defineProperty?</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><h2>Main modules:</h2>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Namespace for houCe functions</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">global.Houce  = </span><span class="p">{}</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Namespace for models</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">global.Models = </span><span class="p">{}</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Namespace for utility libraries</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">global.Utils  = </span><span class="p">{}</span></pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Namespace for configs</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">global.Config = </span><span class="p">{}</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><p>Setup houCe. Called from setup.coffee</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">Houce.init_houce = </span><span class="nf">(args)-&gt;</span>
  <span class="nx">global</span><span class="p">.</span><span class="nx">Data</span> <span class="o">?=</span> <span class="p">{}</span>

  <span class="nv">defaults =</span>
    <span class="nv">main_page: </span><span class="kc">null</span>
    <span class="nv">before_open_page: </span><span class="o">-&gt;</span>
    <span class="nv">after_open_page: </span> <span class="o">-&gt;</span>
    <span class="nv">data_structure: </span><span class="p">{}</span>
    <span class="nv">data_version: </span><span class="mi">1</span>
    <span class="nv">Config:</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>TOOD: use insted Zepto or some other library for mobile stuff?</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nv">is_mobile: </span><span class="nx">navigator</span><span class="p">.</span><span class="nx">userAgent</span><span class="p">.</span><span class="nx">has</span> <span class="sr">/iPhone|Android|Nokia/</span>
      <span class="nv">storage_on: </span><span class="kc">true</span>
    <span class="nv">init_app: </span> <span class="o">-&gt;</span>
    <span class="nv">error_logging: </span><span class="kc">false</span>

  <span class="nv">args = </span><span class="nx">merge</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nx">args</span>

  <span class="nv">Pager.main_page        = </span><span class="nx">args</span><span class="p">.</span><span class="nx">main_page</span>
  <span class="nv">Pager.before_open_page = </span><span class="nx">args</span><span class="p">.</span><span class="nx">before_open_page</span>
  <span class="nv">Pager.after_open_page  = </span><span class="nx">args</span><span class="p">.</span><span class="nx">after_open_page</span>
  <span class="nv">Houce.init_data.app_defaults = </span><span class="nx">args</span><span class="p">.</span><span class="nx">data_structure</span>
  <span class="nv">Houce.init_data.version      = </span><span class="nx">args</span><span class="p">.</span><span class="nx">data_version</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><h2>Error logging to server</h2>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">Houce.error.logging_on = </span><span class="nx">args</span><span class="p">.</span><span class="nx">error_logging</span>
  <span class="k">if</span> <span class="nx">Utils</span><span class="p">.</span><span class="nx">device</span><span class="p">.</span><span class="nx">is_mobile</span><span class="p">()</span> <span class="o">or</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">env</span> <span class="o">is</span> <span class="s">&#39;production&#39;</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">onerror = </span><span class="nx">Houce</span><span class="p">.</span><span class="nx">error</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>if Utils.devise.is_mobile() or Config.env is 'production'</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><h2>Config</h2>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>Client config from setup.coffee</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">merge</span> <span class="nx">Config</span><span class="p">,</span> <span class="nx">args</span><span class="p">.</span><span class="nx">Config</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>Config from server:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">merge</span> <span class="nx">Config</span><span class="p">,</span> <span class="nx">client_config_from_server</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>---Kapsa specific---
Merge host specific config to main config</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>if (host<em>conf = Config.by</em>host[location.host])?
  Object.merge Config, host<em>conf, true
else if (linked</em>host = Config.by<em>host.links[location.host])?
  Object.merge Config, Config.by</em>host[linked<em>host], true
else
  alert 'No config found for: '+location.host
delete Config.by</em>host
---/Kapsa specific---</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>Test local storage:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">try</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>In iphone/ipad private mode this will fail</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">localStorage</span>  <span class="p">.</span><span class="nv">storage_test = </span><span class="s">&#39;works&#39;</span>
    <span class="nv">sessionStorage.storage_test = </span><span class="s">&#39;works&#39;</span>
  <span class="k">catch</span> <span class="nx">err</span> <span class="k">then</span> <span class="nv">Config.storage_on = </span><span class="kc">false</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><h2>Init templates</h2>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">Houce</span><span class="p">.</span><span class="nx">init_templates</span><span class="p">()</span></pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><h2>Namespacing to store all modules under single application object</h2>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">global</span><span class="p">[</span><span class="nx">Config</span><span class="p">.</span><span class="nx">app_name</span><span class="p">]</span> <span class="o">=</span>
    <span class="nv">Config: </span><span class="nx">Config</span>
    <span class="nv">Houce: </span> <span class="nx">Houce</span>
    <span class="nv">Models: </span><span class="nx">Models</span>
    <span class="nv">Utils: </span> <span class="nx">Utils</span>
    <span class="nv">Templates: </span><span class="nx">Templates</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><h2>Data setup</h2>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">Houce</span><span class="p">.</span><span class="nx">init_data</span> <span class="kc">false</span> <span class="c1">#Config.flush_cache or false</span>

  <span class="k">if</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">storage_on</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Bind caching operations to store</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">bind</span> <span class="s">&#39;unload&#39;</span><span class="p">,</span> <span class="nx">Houce</span><span class="p">.</span><span class="nx">cache_data</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>as backup for dirty closing, store cache in intervals:</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">setInterval</span> <span class="nx">Houce</span><span class="p">.</span><span class="nx">cache_data</span><span class="p">,</span> <span class="mi">5</span><span class="p">.</span><span class="nx">minutes</span><span class="p">()</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><h2>Init application</h2>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>check if is auth redirect</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">path = </span><span class="nx">Houce</span><span class="p">.</span><span class="nx">oauth2</span><span class="p">.</span><span class="nx">check_for_access_token</span><span class="p">()</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>execute app specific init</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">args</span><span class="p">.</span><span class="nx">init_app</span><span class="p">()</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>start Pager</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">Pager</span><span class="p">.</span><span class="nx">start_url_checking</span> <span class="nx">path</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Mon Aug 13 2012 14:10:27 GMT+0300 (EEST)  </div></div></body></html>