<!DOCTYPE html><html><head><title>data_and_models.2.coffee</title><meta http-equiv="Content-Type" content="text/html" charset="UTF-8"><link rel="stylesheet" media="all" href="../../docco.css"></head><body><div id="container"><div id="background"></div><div id="jump_to">Jump To &hellip;<div id="jump_wrapper"><div id="jump_page"><a href="../../index.html" class="source"><span class="file_name">README</span></a><a href="../../client/app/setup.-1.html" class="source "><span class="base_path">client / app / </span><span class="file_name">setup.-1.coffee</span></a><a href="../../client/houce/apis.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">apis.coffee</span></a><a href="../../client/houce/data_and_models.2.html" class="source selected"><span class="base_path">client / houce / </span><span class="file_name">data_and_models.2.coffee</span></a><a href="../../client/houce/init_houce.1.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">init_houce.1.coffee</span></a><a href="../../client/houce/page_handler.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">page_handler.coffee</span></a><a href="../../client/houce/templates.html" class="source "><span class="base_path">client / houce / </span><span class="file_name">templates.coffee</span></a><a href="../../client/models/person.html" class="source "><span class="base_path">client / models / </span><span class="file_name">person.coffee</span></a><a href="../../client/styles/ccss_helpers.s.html" class="source "><span class="base_path">client / styles / </span><span class="file_name">ccss_helpers.s.coffee</span></a><a href="../../client/utils/dictionary.html" class="source "><span class="base_path">client / utils / </span><span class="file_name">dictionary.coffee</span></a><a href="../../client/utils/utils.html" class="source "><span class="base_path">client / utils / </span><span class="file_name">utils.coffee</span></a><a href="../../common/common_utils.html" class="source "><span class="base_path">common / </span><span class="file_name">common_utils.coffee</span></a><a href="../../server/config.html" class="source "><span class="base_path">server / </span><span class="file_name">config.coffee</span></a><a href="../../server/houce.html" class="source "><span class="base_path">server / </span><span class="file_name">houce.coffee</span></a><a href="../../server/server.html" class="source "><span class="base_path">server / </span><span class="file_name">server.coffee</span></a><a href="../.././start.html" class="source "><span class="base_path">. / </span><span class="file_name">start.coffee</span></a></div></div></div><table cellpadding="0" cellspacing="0"><thead><tr><th class="docs"><h1>data_and_models.2.coffee</h1><div class="filepath">client/houce/</div></th><th class="code"></th></tr></thead><tbody><tr id="section-1"><td class="docs"><div class="pilwrap"><a href="#section-1" class="pilcrow">&#182;</a></div>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-2"><td class="docs"><div class="pilwrap"><a href="#section-2" class="pilcrow">&#182;</a></div><p>Data initialization and caching
Model helpers</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-3"><td class="docs"><div class="pilwrap"><a href="#section-3" class="pilcrow">&#182;</a></div><p>2 in file name means that this will be the second file exeuted in client_app.js</p>
</td><td class="code"><div class="highlight"><pre></pre></div></td></tr><tr id="section-4"><td class="docs"><div class="pilwrap"><a href="#section-4" class="pilcrow">&#182;</a></div><h3>Data initialization</h3>
</td><td class="code"><div class="highlight"><pre><span class="nv">Houce.init_data = </span><span class="nf">(remove_cache=true)-&gt;</span></pre></div></td></tr><tr id="section-5"><td class="docs"><div class="pilwrap"><a href="#section-5" class="pilcrow">&#182;</a></div><p>Namespace for all retrieved data</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">global.Data  = </span><span class="p">{}</span></pre></div></td></tr><tr id="section-6"><td class="docs"><div class="pilwrap"><a href="#section-6" class="pilcrow">&#182;</a></div><p>Data.version = 4 # increment this version each time Data structure changes; causes the cache to be flushed</p>
</td><td class="code"><div class="highlight"><pre>  
  <span class="k">if</span> <span class="nx">localStorage</span><span class="o">?</span> <span class="o">and</span> <span class="nx">remove_cache</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span> <span class="s">&#39;Data&#39;</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span> <span class="s">&#39;DataVersion&#39;</span><span class="p">,</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">version</span></pre></div></td></tr><tr id="section-7"><td class="docs"><div class="pilwrap"><a href="#section-7" class="pilcrow">&#182;</a></div><p>Session storage:</p>
</td><td class="code"><div class="highlight"><pre>    <span class="nx">sessionStorage</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">key</span> <span class="k">for</span> <span class="nx">key</span> <span class="k">of</span> <span class="nx">sessionStorage</span>

  <span class="k">for</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">model</span> <span class="k">of</span> <span class="nx">Models</span>
    <span class="nx">Data</span><span class="p">[</span><span class="nx">Houce</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">name</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()]</span> <span class="o">=</span> <span class="p">{}</span>
  </pre></div></td></tr><tr id="section-8"><td class="docs"><div class="pilwrap"><a href="#section-8" class="pilcrow">&#182;</a></div><p>Data.cache<em>updated =
  coordinates: null
  last</em>stored: null
Data.misc =
  coord:
    latitude:  null
    longitude: null
  me: null
Data.apis =
  fb:
    access<em>token: null
    #expires: null
  google:
    access</em>token: null</p>
</td><td class="code"><div class="highlight"><pre>    
  <span class="nx">global</span><span class="p">[</span><span class="nx">Config</span><span class="p">.</span><span class="nx">app_name</span><span class="p">].</span><span class="nv">Data = </span><span class="nx">Data</span></pre></div></td></tr><tr id="section-9"><td class="docs"><div class="pilwrap"><a href="#section-9" class="pilcrow">&#182;</a></div><h2>Data caching</h2>
</td><td class="code"><div class="highlight"><pre><span class="nv">Houce.stringify = </span><span class="nf">(main_obj)-&gt;</span></pre></div></td></tr><tr id="section-10"><td class="docs"><div class="pilwrap"><a href="#section-10" class="pilcrow">&#182;</a></div><p>helpers to speed up iteration:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">models_arr = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">values</span> <span class="nx">Models</span>
  <span class="nv">plur_model_names = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">Models</span><span class="p">).</span><span class="nx">map</span> <span class="nf">(m_name)-&gt;</span> <span class="nx">Houce</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">m_name</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span></pre></div></td></tr><tr id="section-11"><td class="docs"><div class="pilwrap"><a href="#section-11" class="pilcrow">&#182;</a></div><p>log 'plur<em>model</em>names', plur<em>model</em>names</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">is_in_models = </span>  <span class="nf">(obj)-&gt;</span> <span class="nx">models_arr</span><span class="p">.</span><span class="nx">has</span> <span class="nf">(el)-&gt;</span> <span class="nx">el</span> <span class="o">is</span> <span class="nx">obj</span><span class="o">?</span><span class="p">.</span><span class="nx">constructor</span>
  <span class="nv">link_model_str = </span><span class="nf">(obj)-&gt;</span> <span class="s">&quot;&#39;Model::</span><span class="si">#{</span><span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="s">::</span><span class="si">#{</span><span class="nx">obj</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s">&#39;&quot;</span></pre></div></td></tr><tr id="section-12"><td class="docs"><div class="pilwrap"><a href="#section-12" class="pilcrow">&#182;</a></div><p>iterator:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">stack = </span><span class="p">[]</span>
  <span class="p">(</span><span class="nv">iterate = </span><span class="nf">(obj)-&gt;</span> <span class="c1"># , treat_as_object=false</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span> <span class="kc">null</span> <span class="c1"># += 1</span>
    <span class="nv">res = </span><span class="k">switch</span> <span class="k">typeof</span> <span class="nx">obj</span> <span class="c1">#obj.constructor</span>
      <span class="k">when</span> <span class="s">&#39;object&#39;</span>
        <span class="k">if</span> <span class="nx">obj</span> <span class="o">is</span> <span class="kc">null</span> <span class="k">then</span> <span class="s">&#39;null&#39;</span>
        <span class="k">else</span></pre></div></td></tr><tr id="section-13"><td class="docs"><div class="pilwrap"><a href="#section-13" class="pilcrow">&#182;</a></div><p>could be object, array, or anything that inherits object (presumably found from Models)</p>
</td><td class="code"><div class="highlight"><pre>          <span class="k">if</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">is</span> <span class="nb">Array</span>
            <span class="nv">obj_strings = </span><span class="k">for</span> <span class="nx">child_obj</span> <span class="k">in</span> <span class="nx">obj</span>
              <span class="k">if</span> <span class="nx">is_in_models</span> <span class="nx">child_obj</span> <span class="k">then</span> <span class="nx">link_model_str</span> <span class="nx">child_obj</span> <span class="o">\</span>
                                        <span class="k">else</span> <span class="nx">iterate</span> <span class="nx">child_obj</span>
            <span class="s">&quot;[</span><span class="si">#{</span> <span class="nx">obj_strings</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;,&#39;</span> <span class="si">}</span><span class="s">]&quot;</span>  
          <span class="k">else</span>
            <span class="nv">obj_strings = </span><span class="k">for</span> <span class="nx">own</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">child_obj</span> <span class="k">of</span> <span class="nx">obj</span>
              <span class="nx">stack</span><span class="p">.</span><span class="nx">splice</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">name</span>
              <span class="k">if</span> <span class="nx">name</span> <span class="o">is</span> <span class="s">&#39;deferred&#39;</span>
                <span class="k">continue</span>
              <span class="k">if</span> <span class="nx">is_in_models</span> <span class="nx">child_obj</span> <span class="c1"># Deal, Coupon, etc...</span></pre></div></td></tr><tr id="section-14"><td class="docs"><div class="pilwrap"><a href="#section-14" class="pilcrow">&#182;</a></div><p>log 'model found', stack.clone()</p>
</td><td class="code"><div class="highlight"><pre>                <span class="nv">value = </span><span class="k">if</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">is</span> <span class="mi">2</span> <span class="o">and</span> <span class="nx">plur_model_names</span><span class="p">.</span><span class="nx">has</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">at</span> <span class="o">-</span><span class="mi">2</span>  <span class="c1">#depth is 2 and plur_model_names.has name</span>
                  <span class="nx">iterate</span> <span class="nx">child_obj</span> <span class="c1"># parent has _store_type defined, so store full object</span>
                <span class="k">else</span>
                  <span class="nx">link_model_str</span> <span class="nx">child_obj</span> <span class="c1"># store only string link</span>
                <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&#39;: </span><span class="si">#{</span><span class="nx">value</span><span class="si">}</span><span class="s">&quot;</span></pre></div></td></tr><tr id="section-15"><td class="docs"><div class="pilwrap"><a href="#section-15" class="pilcrow">&#182;</a></div><p>if obj.<em>store</em>type then "'#{name}': #{iterate child<em>obj}" \
                    else "'#{name}</em>id': #{child_obj.id}"</p>
</td><td class="code"><div class="highlight"><pre>              <span class="k">else</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&#39;: </span><span class="si">#{</span><span class="nx">iterate</span> <span class="nx">child_obj</span><span class="si">}</span><span class="s">&quot;</span>
            <span class="s">&quot;{ </span><span class="si">#{</span><span class="nx">obj_strings</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;,\n&#39;</span><span class="si">}</span><span class="s"> }&quot;</span>
      <span class="k">when</span> <span class="s">&#39;string&#39;</span>    <span class="k">then</span> <span class="s">&quot;&#39;</span><span class="si">#{</span><span class="nx">escape</span> <span class="nx">obj</span><span class="si">}</span><span class="s">&#39;&quot;</span>
      <span class="k">when</span> <span class="s">&#39;undefined&#39;</span> <span class="k">then</span> <span class="s">&#39;undefined&#39;</span>
      <span class="k">when</span> <span class="s">&#39;function&#39;</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;WARNING: Function found when stringifying Data&quot;</span><span class="p">,</span> <span class="nx">stack</span><span class="p">,</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span>
        <span class="s">&#39;null&#39;</span>
      <span class="k">when</span> <span class="s">&#39;number&#39;</span><span class="p">,</span> <span class="s">&#39;boolean&#39;</span> <span class="k">then</span> <span class="nx">obj</span>
      <span class="k">else</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="nx">obj</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="c1">#depth -= 1</span>
    <span class="nx">res</span>
  <span class="p">)(</span> <span class="nx">main_obj</span> <span class="p">)</span>

<span class="nv">Houce.objectify = </span><span class="nf">(str)-&gt;</span></pre></div></td></tr><tr id="section-16"><td class="docs"><div class="pilwrap"><a href="#section-16" class="pilcrow">&#182;</a></div><p>to object:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">main_obj = </span><span class="nb">eval</span> <span class="s">&quot;( </span><span class="si">#{</span><span class="nx">str</span><span class="si">}</span><span class="s"> )&quot;</span>
  </pre></div></td></tr><tr id="section-17"><td class="docs"><div class="pilwrap"><a href="#section-17" class="pilcrow">&#182;</a></div><p>Create model objects:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">for</span> <span class="nx">model_name</span> <span class="k">in</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">Models</span><span class="p">)</span>
    <span class="nv">model_container = </span><span class="nx">main_obj</span><span class="p">[</span><span class="nx">Houce</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">model_name</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()]</span>
    <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">obj</span> <span class="k">of</span> <span class="nx">model_container</span>
      <span class="nx">model_container</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Models</span><span class="p">[</span><span class="nx">model_name</span><span class="p">].</span><span class="nx">new_data</span> <span class="nx">obj</span>
  </pre></div></td></tr><tr id="section-18"><td class="docs"><div class="pilwrap"><a href="#section-18" class="pilcrow">&#182;</a></div><p>helper func to unescape and return model object links:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">check_string = </span><span class="nf">(parent,key)-&gt;</span>
    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;string&#39;</span></pre></div></td></tr><tr id="section-19"><td class="docs"><div class="pilwrap"><a href="#section-19" class="pilcrow">&#182;</a></div><p>log key+' '+parent[key]</p>
</td><td class="code"><div class="highlight"><pre>      <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">unescape</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">][</span><span class="mi">0</span><span class="p">...</span><span class="mi">7</span><span class="p">]</span> <span class="o">is</span> <span class="s">&#39;Model::&#39;</span></pre></div></td></tr><tr id="section-20"><td class="docs"><div class="pilwrap"><a href="#section-20" class="pilcrow">&#182;</a></div><p>log "returning #{parent[key]} from", parent</p>
</td><td class="code"><div class="highlight"><pre>        <span class="p">[</span><span class="nx">m</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">].</span><span class="nx">split</span> <span class="s">&#39;::&#39;</span>
        <span class="nx">parent</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">Data</span><span class="p">[</span><span class="nx">Houce</span><span class="p">.</span><span class="nx">pluralize</span><span class="p">(</span><span class="nx">type</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())][</span><span class="nx">id</span><span class="p">]</span>
      <span class="kc">true</span>
    <span class="k">else</span> <span class="kc">false</span>
  </pre></div></td></tr><tr id="section-21"><td class="docs"><div class="pilwrap"><a href="#section-21" class="pilcrow">&#182;</a></div><p>Iterate through main<em>obj to apply check</em>string for strings:</p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">stack = </span><span class="p">[]</span>
  <span class="p">(</span><span class="nv">iterate = </span><span class="nf">(parent_obj)-&gt;</span>
    <span class="k">return</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">parent_obj</span> <span class="o">isnt</span> <span class="s">&#39;object&#39;</span> <span class="o">or</span> <span class="nx">parent_obj</span> <span class="o">is</span> <span class="kc">null</span></pre></div></td></tr><tr id="section-22"><td class="docs"><div class="pilwrap"><a href="#section-22" class="pilcrow">&#182;</a></div><p>avoid infinite loops:</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">has</span> <span class="nx">parent_obj</span> <span class="k">then</span> <span class="k">return</span> <span class="o">\</span>
                            <span class="k">else</span> <span class="nx">stack</span><span class="p">.</span><span class="nx">push</span> <span class="nx">parent_obj</span>
    <span class="k">if</span> <span class="nx">parent_obj</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">is</span> <span class="nb">Array</span>
      <span class="k">for</span> <span class="nx">obj</span><span class="p">,</span> <span class="nx">ind</span> <span class="k">in</span> <span class="nx">parent_obj</span>
        <span class="nx">iterate</span> <span class="nx">obj</span> <span class="nx">unless</span> <span class="nx">check_string</span> <span class="nx">parent_obj</span><span class="p">,</span> <span class="nx">ind</span>
    <span class="k">else</span>
      <span class="k">for</span> <span class="nx">own</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">obj</span> <span class="k">of</span> <span class="nx">parent_obj</span>
        <span class="nx">iterate</span> <span class="nx">obj</span> <span class="nx">unless</span> <span class="nx">check_string</span> <span class="nx">parent_obj</span><span class="p">,</span> <span class="nx">key</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nx">pop</span><span class="p">()</span> <span class="c1"># keep stack slim for perfomance</span>
    <span class="k">return</span>
  <span class="p">)(</span> <span class="nx">main_obj</span> <span class="p">)</span>
  <span class="nx">main_obj</span>

<span class="nv">Houce.cache_data = </span><span class="o">-&gt;</span>
  <span class="k">return</span> <span class="nx">unless</span> <span class="nx">localStorage</span><span class="o">?</span>
  <span class="nx">console</span><span class="p">.</span><span class="nx">info</span> <span class="s">&quot;Caching data&quot;</span>
  <span class="nv">Data.cache_updated.last_stored = </span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span></pre></div></td></tr><tr id="section-23"><td class="docs"><div class="pilwrap"><a href="#section-23" class="pilcrow">&#182;</a></div><p>Utils.speed_test 'stringifyng', 1, -></p>
</td><td class="code"><div class="highlight"><pre>  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span> <span class="s">&#39;Data&#39;</span><span class="p">,</span> <span class="nx">Houce</span><span class="p">.</span><span class="nx">stringify</span> <span class="nx">Data</span>
  <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span> <span class="s">&#39;DataVersion&#39;</span><span class="p">,</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">version</span>
  <span class="k">if</span> <span class="kc">false</span> <span class="o">and</span> <span class="nx">Config</span><span class="p">.</span><span class="nx">env</span> <span class="o">is</span> <span class="s">&#39;development&#39;</span>
    <span class="nv">temp_data = </span><span class="nb">Object</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">Data</span>
    <span class="nb">window</span><span class="p">.</span><span class="nv">object_again = </span><span class="nx">Houce</span><span class="p">.</span><span class="nx">objectify</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span> <span class="s">&#39;Data&#39;</span>
    <span class="nx">unless</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">equal</span> <span class="nx">temp_data</span><span class="p">,</span> <span class="nx">object_again</span>
      <span class="k">throw</span> <span class="nb">Error</span> <span class="s">&quot;in cache_data: Objectified data not equal to original&quot;</span>

<span class="nv">Houce.cache_valid = </span><span class="nf">(type)-&gt;</span>
  <span class="nv">updated  = </span><span class="k">new</span> <span class="nb">Date</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">cache_updated</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span>
  <span class="nv">time_str = </span><span class="nx">Config</span><span class="p">.</span><span class="nx">cache_update_after</span><span class="p">[</span><span class="nx">type</span><span class="p">]</span>
  <span class="nx">updated</span><span class="p">.</span><span class="nx">isAfter</span> <span class="nx">time_str</span></pre></div></td></tr><tr id="section-24"><td class="docs"><div class="pilwrap"><a href="#section-24" class="pilcrow">&#182;</a></div><p>If you have model names with irregular pluralization,
add the correct pluralization here</p>
</td><td class="code"><div class="highlight"><pre><span class="nv">Houce.pluralize = </span><span class="nf">(word)-&gt;</span>
  <span class="k">switch</span> <span class="nx">word</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
    <span class="k">when</span> <span class="s">&#39;person&#39;</span> <span class="k">then</span> <span class="s">&#39;people&#39;</span>
    <span class="k">else</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">word</span><span class="si">}</span><span class="s">s&quot;</span></pre></div></td></tr><tr id="section-25"><td class="docs"><div class="pilwrap"><a href="#section-25" class="pilcrow">&#182;</a></div><h2>Model helpers</h2>
</td><td class="code"><div class="highlight"><pre><span class="nv">Houce.model_new_data = </span><span class="nf">(class_var)-&gt;</span> <span class="c1"># , fetch_str</span></pre></div></td></tr><tr id="section-26"><td class="docs"><div class="pilwrap"><a href="#section-26" class="pilcrow">&#182;</a></div><p>do -></p>
</td><td class="code"><div class="highlight"><pre>  <span class="nv">c_name        = </span><span class="nx">class_var</span><span class="p">.</span><span class="nx">name</span>
  <span class="nv">c_name_plural = </span><span class="nx">Houce</span><span class="p">.</span><span class="nx">pluralize</span> <span class="nx">c_name</span>
  
  <span class="nv">class_var.new_data = </span><span class="nf">(data)-&gt;</span>
    <span class="k">return</span> <span class="nx">data</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">data</span> <span class="o">isnt</span> <span class="s">&#39;object&#39;</span>
    <span class="k">throw</span> <span class="nv">message: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">c_name</span><span class="si">}</span><span class="s"> data requires an ID&quot;</span><span class="p">,</span> <span class="nv">stack: </span><span class="nx">data</span> <span class="nx">unless</span> <span class="nx">data</span><span class="o">?</span><span class="p">.</span><span class="nx">id</span><span class="o">?</span></pre></div></td></tr><tr id="section-27"><td class="docs"><div class="pilwrap"><a href="#section-27" class="pilcrow">&#182;</a></div><p>merge or create (and link to data)</p>
</td><td class="code"><div class="highlight"><pre>    <span class="k">if</span> <span class="nx">Data</span><span class="p">[</span><span class="nx">c_name_plural</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">Data</span><span class="p">[</span><span class="nx">c_name_plural</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">merge</span> <span class="nx">data</span>
    <span class="k">else</span> <span class="nx">Data</span><span class="p">[</span><span class="nx">c_name_plural</span><span class="p">][</span><span class="nx">data</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">class_var</span> <span class="nx">data</span></pre></div></td></tr><tr id="section-28"><td class="docs"><div class="pilwrap"><a href="#section-28" class="pilcrow">&#182;</a></div><p>WARNING: this is not ready  </p>
</td><td class="code"><div class="highlight"><pre><span class="nv">Houce.deferred_get = </span><span class="nf">(parent, child_name, fetch_str, callback)-&gt;</span></pre></div></td></tr><tr id="section-29"><td class="docs"><div class="pilwrap"><a href="#section-29" class="pilcrow">&#182;</a></div><p>This needs some thinking still..</p>
</td><td class="code"><div class="highlight"><pre>  <span class="k">if</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">child_name</span><span class="p">]</span><span class="o">?</span>
    <span class="nx">callback</span> <span class="nx">parent</span><span class="p">[</span><span class="nx">child_name</span><span class="p">]</span>
  <span class="k">else</span>
    <span class="nx">Houce</span><span class="p">.</span><span class="nx">apis</span><span class="p">.</span><span class="nx">fb_get</span> <span class="nx">fetch_str</span><span class="p">,</span> <span class="nf">(res)-&gt;</span>
      <span class="nv">res = </span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span> <span class="k">if</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="o">?</span>
      <span class="nb">Object</span><span class="p">.</span><span class="nx">each</span> <span class="nx">res</span><span class="p">,</span> <span class="nf">(el, key)-&gt;</span>

</pre></div></td></tr></tbody></table><div id="generated">generated Sun Mar 25 2012 11:24:05 GMT+0300 (EEST)  </div></div></body></html>